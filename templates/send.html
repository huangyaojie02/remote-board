<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>远程留言 - 发送端</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body class="send">
  <h1>远程留言（发送端）</h1>
  <textarea id="msg" rows="6" placeholder="输入要显示给外公的文字..."></textarea>
  <button id="sendBtn">发送</button>
  <p id="hint">状态：等待连接…</p>

  <!-- ⚠️ 用后端自带的 socket.io 客户端，保证版本一致 -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const urlParams = new URLSearchParams(location.search);
    const TOKEN = urlParams.get("t") || ""; // 取 URL 里的 ?t=...

    const msgEl  = document.getElementById("msg");
    const btn    = document.getElementById("sendBtn");
    const hintEl = document.getElementById("hint");

    function show(msg){ hintEl.textContent = "状态：" + msg; }

    // 连接 /send 命名空间
    const socket = io("/send", { transports: ["websocket"] });

    socket.on("connect",       () => show("已连接 /send (id=" + socket.id + ")"));
    socket.on("connect_error", e  => show("连接失败：" + e.message));
    socket.on("disconnect",    r  => show("断开：" + r));

    btn.onclick = () => {
      const text = msgEl.value.trim();
      if (!TOKEN) { show("缺少 token（URL 必须带 ?t=口令）"); return; }
      if (!text)  { show("内容不能为空"); return; }
      show("发送中…");
      socket.emit("push", { token: TOKEN, text });
    };

    socket.on("result", data => {
      if (data.ok) {
        show("✅ " + data.msg);
        // 发送成功后是否清空输入框：可选
        // msgEl.value = "";
      } else {
        show("❌ " + (data.msg || "发送失败"));
      }
    });
  </script>
</body>
</html>
