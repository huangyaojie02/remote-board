<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  // 1) 从 URL 里取 token（/send?t=xxxx）
  const url = new URL(location.href);
  const TOKEN = url.searchParams.get("t") || "";

  // 2) 更“稳”的连接配置：允许 websocket + polling，并指定默认 path
  const socket = io("/send", {
    path: "/socket.io",
    transports: ["websocket", "polling"],
    withCredentials: false,
    reconnection: true,
    reconnectionAttempts: Infinity,
    reconnectionDelay: 1000
  });

  const msgEl = document.getElementById("msg");
  const btn = document.getElementById("sendBtn");
  const hint = document.getElementById("hint");

  // 连接状态提示
  socket.on("connect", () => (hint.textContent = "状态：已连接"));
  socket.on("connect_error", (e) => (hint.textContent = "连接错误：" + e.message));
  socket.on("reconnect_attempt", () => (hint.textContent = "正在重连..."));

  // 发送
  btn.onclick = () => {
    const text = (msgEl.value || "").trim();
    socket.emit("push", { token: TOKEN, text });
  };

  // 结果反馈
  socket.on("result", (data) => {
    hint.textContent = data && data.msg ? data.msg : "";
    // 可选：成功后清空
    // if (data.ok) msgEl.value = "";
  });
</script>
